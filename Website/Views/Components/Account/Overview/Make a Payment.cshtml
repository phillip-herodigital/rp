@model StreamEnergy.MyStream.Models.Account.MakeMultiplePaymentsRequest
<article class="grey-box make-payment" ng-controller="MakePaymentCtrl">  
    <header>
        <h2>@Html.Sitecore().Field("Make Payment Text")</h2>
    </header>
    <div ng-show="activeState == 'step1'">
        <form data-val-bind-messages="validations" ng-submit="resolvePaymentMethod()">
            <div class="content grid-table-content" loading-indicator>
                <div class="payment-account stretch">
                    <table grid-table ng-model="accountsTable" class="grid-table">
                        <thead grid-table-header checkboxes="true"></thead>
                        <tbody ng-repeat="item in table.valuesToShow">
                            <tr>
                                <td class="align-center" style="width:30px;"><input type="checkbox" ng-show="item.canMakeOneTimePayment" ng-model="item.selected" /></td>
                                <td ng-show="hasHiddenColumns" ng-click="expandInnerTable($index)" ng-class="{'opened': expand[$index], 'closed': !expand[$index]}">
                                    <i ng-class="{'icon-arrow-expanded': expand[$index], 'icon-arrow-collapsed': !expand[$index]}"></i>
                                </td>
                                <td ng-show="showColumn('accountNumber')">{{ item.accountNumber }}</td>
                                <td ng-show="showColumn('amountDue')">{{ item.amountDue | currency }}</td>
                                <td ng-show="showColumn('dueDate')">{{ item.dueDate | date:'MM/dd/yyyy' }}</td>
                                <td ng-show="showColumn('action')">
                                    <a class="button secondary" ng-if="item.actions.viewPdf" ng-href="{{item.actions.viewPdf}}">@Html.Sitecore().Field("View PDF Text")</a>
                                    <div class="request-extension" ng-show="item.canRequestExtension"><a href="#">@Html.Sitecore().Field("Request Extension Text")</a></div>
                                </td>
                            </tr>
                            <tr class="details" ng-show="!item.canMakeOneTimePayment">
                                <td colspan="{{table.columnList.length+2}}">
                                    @Html.Sitecore().Field("One Time Payment Not Allowed Text").Format(new { AccountNumber = "{{ item.accountNumber }}" })
                                </td>
                            </tr>
                            <tr class="details" ng-show="item.selected">
                                <td colspan="{{table.columnList.length+2}}">
                                    <div class="group item-payment">
                                        <div class="item">
                                            <label for="PaymentAmount">@Html.Sitecore().Field("Payment Amount Text")</label>
                                            <input type="text" ng-model="item.paymentAmount" currency_input value="{{item.amountDue}}" />
                                        </div>
                                        <div class="item">
                                            <label for="PaymentAccount">@Html.Sitecore().Field("Payment Account Text")</label>
                                            @Html.DropDownListFor(m => m.Accounts[0].PaymentAccount,
                                            new[] { new SelectListItem { Text = Html.Sitecore().Field("Select Payment Account Text").ToHtmlString() } },
                                            new { ng_options = "option.displayName for option in item.availablePaymentMethods", ng_model = "item.selectedPaymentMethod" })
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details" ng-show="hasHiddenColumns && expand[$index] == true">
                                <td colspan="{{table.columnList.length+2}}">
                                    <p ng-repeat="column in table.columnList | filter:{isVisible: false}" ng-switch on="column.field">
                                        <span ng-switch-when="actions">
                                            <a class="button secondary" ng-if="item.actions.viewPdf" ng-href="{{item.actions.viewPdf}}">@Html.Sitecore().Field("View PDF Text")</a>
                                        </span>
                                        <span ng-switch-default>
                                            <strong>{{ column.displayName }}:</strong> {{ item[column.field] }}
                                        </span>
                                    </p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="payment-details">
                    <p ng-if="selectedAccounts.length==1">@Html.Sitecore().Field("Total For 1 Account") <strong>{{ total | currency }}</strong></p>
                    <p ng-if="selectedAccounts.length!=1">@Html.Sitecore().Field("Total For Accounts").Format(new { Count = "{{selectedAccounts.length}}" }) <strong>{{total | currency }}</strong></p>

                    <div class="group date-amount">
                        <div class="item datepicker group-col" @Html.Validation().ErrorClass(m => m.PaymentDate)>
                            <label for="PaymentDate">@Html.Sitecore().Field("Payment Date Text")</label>
                            <span class="calendar">
                                @Html.TextBoxFor(m => m.PaymentDate, new { ng_model="selectedDate", datepicker_popup="", is_open="datePickerOpened", ng_click="openDatePicker($event)", min_date="minDate", date_disabled="disableWeekends(date, mode)" })
                                <span class="icon" ng-click="openDatePicker($event)"><i class="icon-calendar"></i></span>
                            </span>
                        </div>
                    </div>
                  
                </div>
            </div>
            <footer>
                <div class="buttons">
                    <button type="submit" data-val-submit>@Html.Sitecore().Field("Continue Button Text")</button>
                </div>
            </footer>
        </form>
    </div>

    <div ng-if="activeState == 'step2'">
        <form>
            <div class="content">
                <dl class="clearfix module-list" ng-repeat="account in selectedAccounts">
                    <dt>@Html.Sitecore().Field("Account Number Text")</dt>
                    <dd>{{account.accountNumber}}</dd>
                    <dt>@Html.Sitecore().Field("Payment Amount Text")</dt>
                    <dd>{{ (selectedAccounts.length != 1 ? account.invoiceAmount : paymentAmount) | currency }}</dd>
                </dl>

                <dl class="clearfix module-list">
                    <dt>@Html.Sitecore().Field("Payment Date Text")</dt>
                    <dd>{{ selectedDate | date:'MM/dd/yyyy' }}</dd>
                    <dt>@Html.Sitecore().Field("Total Payment Text")</dt>
                    <dd>{{ paymentAmount | currency }}</dd>
                </dl>

                <div ng-switch="evaluatedPaymentMethod.underlyingPaymentType || evaluatedPaymentMethod.paymentType">
                    <dl class="clearfix module-list payment-module" ng-switch-when="TokenizedCard">
                        <dt>@Html.Sitecore().Field("Payment Method Text")</dt>
                        <dd>@Html.Sitecore().Field("Credit Card Text")</dd>
                        <dt>@Html.Sitecore().Field("Card Number Text")</dt>
                        <dd>{{evaluatedPaymentMethod.redactedData}}</dd>
                    </dl>
                    <dl class="clearfix module-list payment-module" ng-switch-when="TokenizedBank">
                        <dt>@Html.Sitecore().Field("Payment Method Text")</dt>
                        <dd>@Html.Sitecore().Field("Bank Account Text")</dd>
                        <dt>@Html.Sitecore().Field("Bank Account Number Text")</dt>
                        <dd>{{evaluatedPaymentMethod.redactedData}}</dd>
                    </dl>
                </div>
            </div>
            <footer>
                <div class="buttons">
                    <button type="submit" ng-click="makePayment()">@Html.Sitecore().Field("Submit Payment Button Text")</button>
                    <button class="secondary" type="button" ng-click="activeState = 'step1'">@Html.Sitecore().Field("Back Button Text")</button>
                </div>
            </footer>
        </form>
    </div>

    <div ng-if="activeState == 'step3'">
        <form>
            <div class="content">
                <div ng-repeat="account in selectedAccounts">
                    <h3>@Html.Sitecore().Field("Account Number Label")</h3>
                    <h3>{{account.accountNumber}}</h3>
                    <div ng-if="account.confirmationNumber" class="notice success">
                        <dl class="clearfix module-list">
                            <dt>@Html.Sitecore().Field("Confirmation Number Text")</dt>
                            <dd>{{account.confirmationNumber}}</dd>
                            <dt>@Html.Sitecore().Field("Payment Amount Text")</dt>
                            <dd>{{ (selectedAccounts.length != 1 ? account.invoiceAmount : paymentAmount) | currency }}</dd>
                        </dl>
                    </div>
                    <div ng-if="!account.confirmationNumber" class="notice error">
                        <p>@Html.Sitecore().Field("Processing Payment Error Text").Format(new { Payment = "{{ (selectedAccounts.length != 1 ? account.invoiceAmount : paymentAmount) | currency }}" })</p>
                        @* TODO - Sitecore *@
                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi consectetur, tellus semper porta ornare, nisl tortor adipiscing nibh, eu pretium ligula purus sed arcu.</p>
                    </div>
                    <hr class="content-divider">
                </div>

                <dl class="clearfix module-list">
                    <dt>@Html.Sitecore().Field("Payment Date Text")</dt>
                    <dd>{{ selectedDate | date:'MM/dd/yyyy' }}</dd>
                    <dt>@Html.Sitecore().Field("Total Payment Text")</dt>
                    <dd>{{ paymentAmount | currency }}</dd>
                </dl>

                <div ng-switch="evaluatedPaymentMethod.underlyingPaymentType || evaluatedPaymentMethod.paymentType">
                    <dl class="clearfix module-list payment-module" ng-switch-when="TokenizedCard">
                        <dt>@Html.Sitecore().Field("Payment Method Text")</dt>
                        <dd>@Html.Sitecore().Field("Credit Card Text")</dd>
                        <dt>@Html.Sitecore().Field("Card Number Text")</dt>
                        <dd>{{evaluatedPaymentMethod.redactedData}}</dd>
                    </dl>
                    <dl class="clearfix module-list payment-module" ng-switch-when="TokenizedBank">
                        <dt>@Html.Sitecore().Field("Payment Method Text")</dt>
                        <dd>@Html.Sitecore().Field("Bank Account Text")</dd>
                        <dt>@Html.Sitecore().Field("Bank Account Number Text")</dt>
                        <dd>{{evaluatedPaymentMethod.redactedData}}</dd>
                    </dl>
                </div>
            </div>
            <footer>
                <div class="buttons">
                    @Html.Sitecore().Field("Payment History Link")
                    @Html.Sitecore().Field("Account Overview Link")
                </div>
            </footer>
        </form>
    </div>

</article>

<script type="text/ng-template" id="PaymentBlockingAlert/Duplicate">
    <div class="modal-header">
        <a href="" ng-click="$dismiss()"></a>
        <h2>@Html.Sitecore().Field("Duplicate Payment Header Text")</h2>
    </div>
    <div class="modal-body">
        @Html.Sitecore().Field("Duplicate Payment Body Text")
    </div>
    <div class="modal-footer">
        <button class="secondary" type="button" ng-click="$dismiss()">@Html.Sitecore().Field("Cancel Payment Button Text")</button>
        <button type="button" ng-click="$close()">@Html.Sitecore().Field("Continue Payment Button Text")</button>
    </div>
</script>

<script type="text/ng-template" id="PaymentBlockingAlert/Overpayment">
    <div class="modal-header">
        <a href="" ng-click="$dismiss()"></a>
        <h2>@Html.Sitecore().Field("Overpayment Header Text")</h2>
    </div>
    <div class="modal-body">
        @Html.Sitecore().Field("Overpayment Body Text").Format(new { Payment = "{{paymentAmount|currency}}" })
    </div>
    <div class="modal-footer">
        <button class="secondary" type="button" ng-click="$dismiss()">@Html.Sitecore().Field("Cancel Payment Button Text")</button>
        <button type="button" ng-click="$close()">@Html.Sitecore().Field("Continue Payment Button Text")</button>
    </div>
</script>
