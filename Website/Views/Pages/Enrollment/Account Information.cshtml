@model StreamEnergy.DomainModels.Enrollments.UserContext
@using TypedPhone = StreamEnergy.DomainModels.TypedPhone
@using StreamEnergy.DomainModels.Enrollments
<div id="accountInformation" class="enrollment" ng-if="stepsService.isStepVisible('accountInformation')" ng-controller="EnrollmentAccountInformationCtrl" ng-init="usStates = @(Html.Action("States", "Data").ToHtmlString()); phoneTypes = @(Html.Action("PhoneCategories", "Data").ToHtmlString()); setTimeRemaining('accountInformation', '@Html.Sitecore().Field("Remaining Minutes Number")');">
    <div class="banner enrollment__banner" style="@Html.AsBackgroundStyle("Banner Image")">
        <div class="wrapper clearfix">
            <h1>
                <span class="small block">@Html.Sitecore().Field("Banner Header Text")</span><br />
                <span class="block">@Html.Sitecore().Field("Banner Sub Header Text")</span>
            </h1>
        </div>
    </div>
    <div class="wrapper layout cols-2">
        <aside class="enrollment__nav">
            <div ng-include ng-if="true" src="'enrollment-nav-template'" ng-init="name = 'accountInformation'"></div>
        </aside>
        <section>
            <form data-val-bind-messages="validations" ng-submit="completeStep()">
 
                @* Loop through utility addresses *@
                <article class="enrollment__box form" ng-repeat="(index, item) in utilityAddresses()" ng-init="init();">
                    <header>
                        <h1>@Html.Sitecore().Field("Header Account Information")</h1>
                    </header>
                    <div class="content">
                        <p>@Html.Sitecore().Field("Fill in Information")</p>
                        @* Service Address *@
                        <div class="item item--no-input" ng-if="item.location.address.line1">
                            <label for="service-address">@Html.Sitecore().Field("Service Address Label")</label>
                            <strong>{{ item.location.address | address }}</strong>
                        </div>

                        @* Address Input Dropdown *@
                        <div class="item" ng-if="!item.location.address.line1">
                            <label for="service-address">@Html.Sitecore().Field("Service Address Label")</label>
                            <input type="text"
                                   id="service-address"
                                   class="typeahead"
                                   ng-model="item.tempLocation"
                                   placeholder="123 Main Street, Dallas, TX 75001"
                                   typeahead="location as location.address|address for location in getLocation(item.location.address.stateAbbreviation, $viewValue)"
                                   typeahead-loading="accountInformation.loadingAccountInformationServiceAddress"
                                   ng-class="{'loading' : accountInformation.loadingAccountInformation}" autocomplete="off" />
                        </div>

                        @*Selected Offers Section*@
                        <div ng-repeat="offerInformation in item.offerInformationByType">
                            <div ng-repeat="selectedOffer in offerInformation.value.offerSelections">
                                <div ng-include src="'offerOptions/' + selectedOffer.optionRules.optionRulesType"></div>
                            </div>
                        </div>
                    </div>
                </article>

                <article class="enrollment__box form" ng-if="!isRenewal">
                    <header>
                        <h1>@Html.Sitecore().Field("Personal Information Header")</h1>
                    </header>
                    <div class="content">
                        <div class="group">
                         <div class="item group-col" @Html.Validation().ErrorClass(m => m.ContactInfo.Name.First)>
                                <label for="@Html.IdFor(m => m.ContactInfo.Name.First)">@Html.Sitecore().Field("First Name Label")</label>
                                @Html.TextBoxFor(m => m.ContactInfo.Name.First, new { placeholder="Jordan", ng_model="accountInformation.contactInfo.name.first" })
                                @Html.ValidationMessageFor(model => model.ContactInfo.Name.First)
                            </div>
                            <div class="item group-col" @Html.Validation().ErrorClass(m => m.ContactInfo.Name.Last)>
                                <label for="@Html.IdFor(m => m.ContactInfo.Name.Last)">@Html.Sitecore().Field("Last Name Label")</label>
                                @Html.TextBoxFor(m => m.ContactInfo.Name.Last, new { placeholder = "Campbell", ng_model = "accountInformation.contactInfo.name.last" })
                                @Html.ValidationMessageFor(model => model.ContactInfo.Name.Last)
                            </div>
                        </div>
                        <div class="group">
                            @using (var firstPhone = Html.ClientRepeater(m => m.ContactInfo.Phone, "0").Shortcut(m => (TypedPhone)m))
                            { 
                            <div class="item group-col" @firstPhone.Validation().ErrorClass(m => m.Number)>
                                <label for="@firstPhone.Fix(h => h.IdFor(m => m.Number))">@Html.Sitecore().Field("Primary Phone Number Label")</label>
                                @firstPhone.Fix(h => h.TextBoxFor(m => m.Number, new { type="tel", ng_model = "accountInformation.contactInfo.phone[0].number" }))
                                @firstPhone.ValidationMessageFor(m => m.Number)
                            </div>                        
                            <div class="item group-col" @firstPhone.Validation().ErrorClass(m => m.Category)>
                                <label for="@firstPhone.Fix(h => h.IdFor(m => m.Category))">@Html.Sitecore().Field("Phone Type Label")</label>
                                @firstPhone.Fix(h => h.DropDownListFor(m => m.Category,
                                                        new SelectListItem[] { new SelectListItem { Text = Html.Sitecore().Field("Select Option Please Choose").ToString(), Value = "" } },
                                                        new
                                                        {
                                                            ng_model = "accountInformation.contactInfo.phone[0].category",
                                                            ng_options = "type.name as type.display for type in phoneTypes"
                                                        }))
                                @firstPhone.ValidationMessageFor(m => ((TypedPhone)m).Category)
                            </div>
                            }
                        </div>
                        <div class="additional-field-action">
                            <a href="" ng-click="accountInformation.contactInfo.phone[1] = {}" ng-hide="accountInformation.contactInfo.phone.length > 1">@Html.Sitecore().Field("Add additional phone number")</a>
                            <a href="" ng-click="accountInformation.contactInfo.phone.splice(1, 1)" ng-show="accountInformation.contactInfo.phone.length > 1">@Html.Sitecore().Field("Remove additional phone number")</a>
                        </div>
                        <div class="additional-field-group" ng-show="accountInformation.contactInfo.phone.length > 1">
                            <div class="group">
                                @using (var secondPhone = Html.ClientRepeater(m => m.ContactInfo.Phone, "1").Shortcut(m => (TypedPhone)m))
                                { 
                                <div class="item group-col" @secondPhone.Validation().ErrorClass(m => m.Number)>
                                    <label for="@secondPhone.Fix(h => h.IdFor(m => m.Number))">@Html.Sitecore().Field("Secondary Phone Number Label")</label>
                                    @secondPhone.Fix(h => h.TextBoxFor(m => m.Number, new { type = "tel", ng_model = "accountInformation.contactInfo.phone[1].number", data_val_if = "accountInformation.contactInfo.phone.length > 1" }))
                                    @secondPhone.ValidationMessageFor(m => m.Number)
                                </div>
                                <div class="item group-col" @secondPhone.Validation().ErrorClass(m => m.Category)>
                                    <label for="@secondPhone.Fix(h => h.IdFor(m => m.Category))">@Html.Sitecore().Field("Phone Type Label")</label>
                                    @secondPhone.Fix(h => h.DropDownListFor(m => m.Category,
                                                        new SelectListItem[] { new SelectListItem { Text = Html.Sitecore().Field("Select Option Please Choose").ToString(), Value = "" } },
                                                        new
                                                        {
                                                            ng_model = "accountInformation.contactInfo.phone[1].category",
                                                            ng_options = "type.name as type.display for type in phoneTypes",
                                                            data_val_if = "accountInformation.contactInfo.phone.length > 1"
                                                        }))
                                    @secondPhone.ValidationMessageFor(m => ((TypedPhone)m).Category)
                                </div>
                                }
                            </div>
                        </div>
                        <hr class="content-divider">
                        <div class="item" @Html.Validation().ErrorClass(m => m.ContactInfo.Email.Address)>
                            <label for="@Html.IdFor(m => m.ContactInfo.Email.Address)">@Html.Sitecore().Field("Email Address Label")</label>
                            @Html.TextBoxFor(m => m.ContactInfo.Email.Address, new { type = "email", ng_model = "accountInformation.contactInfo.email.address" })
                            @Html.ValidationMessageFor(model => model.ContactInfo.Email.Address)
                        </div>      

                        <div>
                            <h3>@Html.Sitecore().Field("Billing Address Header")</h3>
                            <div class="item">
                                <ul class="checkbox-list">
                                    <li>
                                        <input type="checkbox" name="same-address-mailing" id="same-address-mailing" ng-model="accountInformation.mailingAddressSame" ng-change="updateSameAddress()">
                                        <label for="same-address-mailing">@Html.Sitecore().Field("Same Address Label")</label>
                                    </li>
                                </ul>
                            </div>
                            <div class="item" ng-show="accountInformation.mailingAddressSame && utilityAddresses().length > 1">
                                <label for="service-address-mailing">@Html.Sitecore().Field("Select Service Address Label")</label>
                                <select id="service-address-mailing"
                                        ng-model="accountInformation.mailingAddress"
                                        ng-change="updateBillingAddress()"
                                        ng-options="entry.location.address as entry.location.address | address for entry in utilityAddresses()">
                                    <option value="">@Html.Sitecore().Field("Select Option Please Choose")</option>
                                </select>
                            </div>
                            <div class="item item--no-input" ng-show="accountInformation.mailingAddressSame && utilityAddresses().length == 1">
                                <label>@Html.Sitecore().Field("Billing Service Address Label")</label>
                                <strong>{{ accountInformation.mailingAddress | address }}</strong>
                            </div>
                            @using (var billingAddress = Html.Shortcut(m => m.MailingAddress))
                            {
                                <div ng-hide="accountInformation.mailingAddressSame">
                                    <div class="group">
                                        <div class="item group-col" @(billingAddress.Validation().ErrorClass(m => m.Line1))>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.Line1))">@Html.Sitecore().Field("Address 1 Label")</label>
                                            @billingAddress.Fix(h => h.TextBoxFor(m => m.Line1, new { data_val_if = "!accountInformation.mailingAddressSame", ng_model = "accountInformation.mailingAddress.line1" }))
                                            @billingAddress.ValidationMessageFor(m => m.Line1)
                                        </div>
                                        <div class="item group-col" @billingAddress.Validation().ErrorClass(m => m.Line2)>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.Line2))">@Html.Sitecore().Field("Address 2 Label")</label>
                                            @billingAddress.Fix(h => h.TextBoxFor(m => m.Line2, new { data_val_if = "!accountInformation.mailingAddressSame", ng_model = "accountInformation.mailingAddress.line2" }))
                                            @billingAddress.ValidationMessageFor(m => m.Line2)
                                        </div>
                                    </div>
                                    <div class="group">
                                        <div class="item group-col" @billingAddress.Validation().ErrorClass(m => m.City)>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.City))">@Html.Sitecore().Field("City Label")</label>
                                            @billingAddress.Fix(h => h.TextBoxFor(m => m.City, new { data_val_if = "!accountInformation.mailingAddressSame", ng_model = "accountInformation.mailingAddress.city" }))
                                            @billingAddress.ValidationMessageFor(m => m.City)
                                        </div>
                                        <div class="item" @billingAddress.Validation().ErrorClass(m => m.StateAbbreviation)>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.StateAbbreviation))">@Html.Sitecore().Field("State Label")</label>
                                            @billingAddress.Fix(h => h.DropDownListFor(m => m.StateAbbreviation,
                                                        new SelectListItem[] { new SelectListItem { Text = Html.Sitecore().Field("Select Option Please Choose").ToString(), Value = "" } },
                                                        new
                                                        {
                                                            data_val_if = "!accountInformation.mailingAddressSame",
                                                            ng_model = "accountInformation.mailingAddress.stateAbbreviation",
                                                            ng_options = "state.abbreviation as state.display for state in usStates"
                                                        }))
                                            @billingAddress.ValidationMessageFor(m => m.StateAbbreviation)
                                        </div>
                                        <div class="item" @billingAddress.Validation().ErrorClass(m => m.PostalCode5)>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.PostalCode5))">@Html.Sitecore().Field("Zip Label")</label>
                                            @billingAddress.Fix(h => h.TextBoxFor(m => m.PostalCode5, new { @class = "small", data_val_if = "!accountInformation.mailingAddressSame", ng_model = "accountInformation.mailingAddress.postalCode5" }))
                                            @billingAddress.ValidationMessageFor(m => m.PostalCode5)
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div ng-show="hasMoveIn">
                            <h3>@Html.Sitecore().Field("Previous Address Header")</h3>
                            @using (var billingAddress = Html.Shortcut(m => m.PreviousAddress))
                            {
                                <div>
                                    <div class="group">
                                        <div class="item group-col" @(billingAddress.Validation().ErrorClass(m => m.Line1))>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.Line1))">@Html.Sitecore().Field("Address 1 Label")</label>
                                            @billingAddress.Fix(h => h.TextBoxFor(m => m.Line1, new { data_val_if = "hasMoveIn", ng_model = "accountInformation.previousAddress.line1" }))
                                            @billingAddress.ValidationMessageFor(m => m.Line1)
                                        </div>
                                        <div class="item group-col" @billingAddress.Validation().ErrorClass(m => m.Line2)>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.Line2))">@Html.Sitecore().Field("Address 2 Label")</label>
                                            @billingAddress.Fix(h => h.TextBoxFor(m => m.Line2, new { data_val_if = "hasMoveIn", ng_model = "accountInformation.previousAddress.line2" }))
                                            @billingAddress.ValidationMessageFor(m => m.Line2)
                                        </div>
                                    </div>
                                    <div class="group">
                                        <div class="item group-col" @billingAddress.Validation().ErrorClass(m => m.City)>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.City))">@Html.Sitecore().Field("City Label")</label>
                                            @billingAddress.Fix(h => h.TextBoxFor(m => m.City, new { data_val_if = "hasMoveIn", ng_model = "accountInformation.previousAddress.city" }))
                                            @billingAddress.ValidationMessageFor(m => m.City)
                                        </div>
                                        <div class="item" @billingAddress.Validation().ErrorClass(m => m.StateAbbreviation)>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.StateAbbreviation))">@Html.Sitecore().Field("State Label")</label>
                                            @billingAddress.Fix(h => h.DropDownListFor(m => m.StateAbbreviation,
                                                        new SelectListItem[] { new SelectListItem { Text = Html.Sitecore().Field("Select Option Please Choose").ToString(), Value = "" } },
                                                        new
                                                        {
                                                            data_val_if = "hasMoveIn",
                                                            ng_model = "accountInformation.previousAddress.stateAbbreviation",
                                                            ng_options = "state.abbreviation as state.display for state in usStates"
                                                        }))
                                            @billingAddress.ValidationMessageFor(m => m.StateAbbreviation)
                                        </div>
                                        <div class="item" @billingAddress.Validation().ErrorClass(m => m.PostalCode5)>
                                            <label for="@billingAddress.Fix(h => h.IdFor(m => m.PostalCode5))">@Html.Sitecore().Field("Zip Label")</label>
                                            @billingAddress.Fix(h => h.TextBoxFor(m => m.PostalCode5, new { @class = "small", data_val_if = "hasMoveIn", ng_model = "accountInformation.previousAddress.postalCode5" }))
                                            @billingAddress.ValidationMessageFor(m => m.PostalCode5)
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        @*
                        <!-- Change this ng-hide option when commercial becomes available -->                       
                        <div class="item" ng-hide="true">                        
                            <label>@Html.Sitecore().Field("Social Security Number or Tax ID Number Label")</label>
                            <ul class="checkbox-list">
                                <li><input type="radio" id="ssn" ng-model="accountInformation.personalInformation.taxid"><label for="ssn">@Html.Sitecore().Field("Checkbox List Social Security Number" )</label></li>
                                <li><input type="radio" id="taxid" ng-model="accountInformation.personalInformation.taxid"><label for="taxid">@Html.Sitecore().Field("Checkbox List Tax ID")</label></li>
                            </ul>
                        </div>
                        *@
                        <div class="item" @Html.Validation().ErrorClass(m => m.SocialSecurityNumber)>
                            <label for="@Html.IdFor(m => m.SocialSecurityNumber)">@Html.Sitecore().Field("Social Security Number Label")</label>
                            @Html.TextBoxFor(m => m.SocialSecurityNumber, new { ng_model = "accountInformation.socialSecurityNumber" })
                            @Html.ValidationMessageFor(m => m.SocialSecurityNumber)
                        </div>                        
                        @*
                        <!-- Change this ng-hide option when commercial becomes available -->
                        <div class="item" ng-hide="true">
                            <label for="dba">@Html.Sitecore().Field("DBA Label")</label>
                            <input type="text" id="dba" ng-model="accountInformation.dba" />
                        </div>
                        *@

                        <div class="additional-field-item item">
                            <ul class="checkbox-list">
                                <li><input type="checkbox" name="secondary-contact" id="secondary-contact" ng-model="additionalInformation.showSecondaryContact"><label for="secondary-contact">@Html.Sitecore().Field("Checkbox Add Secondary Contact")</label></li>
                            </ul>
                        </div>

                        <div class="additional-field-group" ng-if="additionalInformation.showSecondaryContact">
                            <div class="group">
                                <div class="item group-col" @Html.Validation().ErrorClass(m => m.SecondaryContactInfo.First)>
                                    <label for="@Html.IdFor(m => m.SecondaryContactInfo.First)">@Html.Sitecore().Field("First Name Label")</label>
                                    @Html.TextBoxFor(m => m.SecondaryContactInfo.First, new { data_val_if = "accountInformation.showSecondaryContact", placeholder = "Jordan", ng_model = "accountInformation.secondaryContactInfo.first" })
                                    @Html.ValidationMessageFor(m => m.SecondaryContactInfo.First)
                                </div>
                                <div class="item group-col" @Html.Validation().ErrorClass(m => m.SecondaryContactInfo.Last)>
                                    <label for="@Html.IdFor(m => m.SecondaryContactInfo.Last)">@Html.Sitecore().Field("Last Name Label")</label>
                                    @Html.TextBoxFor(m => m.SecondaryContactInfo.Last, new { data_val_if = "accountInformation.showSecondaryContact", placeholder = "Campbell", ng_model = "accountInformation.secondaryContactInfo.last" })
                                    @Html.ValidationMessageFor(m => m.SecondaryContactInfo.Last)
                                </div>
                            </div> 
                        </div>
                    </div>
                </article>


                @* User Account Creation *@
                <article class="form enrollment__box enrollment__box--account-creation" ng-if="!isRenewal && false">
                    <header>
                        <h1>@Html.Sitecore().Field("Create Online Account Header")</h1>@*Social box header: Social Box Header*@
                    </header>
                    <div class="content">
                        @*<div class="social-box">
                            <p>@Html.Sitecore().Field("Social Box Intro")</p>
                            <p class="social-buttons">
                                <a class="button social facebook" href=""><span class="icon-holder"><i class="icon-facebook"></i></span> @Html.Sitecore().Field("Social Box Facebook")</a>
                                <a class="button social twitter" href=""><span class="icon-holder"><i class="icon-twitter"></i></span> @Html.Sitecore().Field("Social Box Twitter")</a>
                                <a class="button social linkedin" href=""><span class="icon-holder"><i class="icon-linkedin"></i></span> @Html.Sitecore().Field("Social Box LinkedIn")</a>
                            </p>
                            <div class="seperator">@Html.Sitecore().Field("Seperator")</div>
                        </div>
                        <h2>@Html.Sitecore().Field("Create Online Account Header")</h2>*@

                        <p>@Html.Sitecore().Field("Online Account Paragraph")</p>
                        <div class="item" @Html.Validation().ErrorClass(m => m.OnlineAccount.Username)>
                            <label for="@Html.IdFor(m => m.OnlineAccount.Username)">@Html.Sitecore().Field("Username Optional Label")</label>
                            @Html.TextBoxFor(m => m.OnlineAccount.Username, new { data_val_if = "accountInformation.onlineAccount.username", ng_model = "accountInformation.onlineAccount.username", autocomplete = "off" })
                            @Html.ValidationMessageFor(m => m.OnlineAccount.Username)
                        </div>
                        <div class="group">
                            <div class="item group-col" @Html.Validation().ErrorClass(m => m.OnlineAccount.Password)>
                                <label for="@Html.IdFor(m => m.OnlineAccount.Password)">@Html.Sitecore().Field("Password Optional Label")</label>
                                @Html.PasswordFor(m => m.OnlineAccount.Password, new { data_val_if = "accountInformation.onlineAccount.username", ng_model = "accountInformation.onlineAccount.password", autocomplete = "off" })
                                @Html.ValidationMessageFor(m => m.OnlineAccount.Password)
                            </div>
                            <div class="item group-col" @Html.Validation().ErrorClass(m => m.OnlineAccount.ConfirmPassword)>
                                <label for="@Html.IdFor(m => m.OnlineAccount.ConfirmPassword)">@Html.Sitecore().Field("Verify Password Label")</label>
                                @Html.PasswordFor(m => m.OnlineAccount.ConfirmPassword, new { data_val_if = "accountInformation.onlineAccount.username", ng_model = "accountInformation.onlineAccount.confirmPassword", autocomplete = "off" })
                                @Html.ValidationMessageFor(m => m.OnlineAccount.ConfirmPassword)
                            </div>
                        </div>
                    </div>
                </article>

                <div class="buttons">
                    <button type="submit" class="primary" ng-disabled="!isFormValid()" data-val-submit>@Html.Sitecore().Field("Button Label")</button>
                </div>
            </form>
            <div class="hide-medium-large time-remaining-mobile">
                <p class="time-remaining">@Html.Sitecore().Field("Estimated Time Remaining") <strong>@Html.Sitecore().Field("Remaining Minutes")</strong></p>
                <p><a href="">@Html.Sitecore().Field("Info needed")</a></p>
            </div>
        </section>
        <aside>
            <div ng-include ng-if="true" src="'cart-template'"></div>
        </aside>
    </div>       
</div>

<script type="text/ng-template" id="offerOptions/TexasElectricity">
    @using (var offer = Html.ClientRepeater(m => m.Services, "{{$parent.$index}}").ClientRepeater(m => m.SelectedOffers, "{{$index}}"))
    {
    <div @*ng-controller="OfferOptions-TexasElectricity"*@>
        <h2>Electricity</h2>
        @* No options here since billing address is handled outside of this loop *@
    </div>
    }
</script>

<script type="text/ng-template" id="offerOptions/TexasElectricityMoveIn">
    @using (var offer = Html.ClientRepeater(m => m.Services, "{{$parent.$index}}").ClientRepeater(m => m.SelectedOffers, "{{$index}}"))
    {
    <div ng-controller="OfferOptions-TexasElectricityMoveIn">
        <h2>Electricity</h2>
        <div class="item group-col datepicker" @offer.Validation().ErrorClass(o => ((TexasElectricityMoveInOfferOption)o.OfferOption).ConnectDate)>
            <label for="@offer.Fix(h => h.IdFor(o => ((TexasElectricityMoveInOfferOption)o.OfferOption).ConnectDate))">@Html.Sitecore().Field("Service Start Date Label")</label>
            <input type="text" class="datepicker-input" id="@offer.Fix(h => h.IdFor(o => ((TexasElectricityMoveInOfferOption)o.OfferOption).ConnectDate))" ng-model="selectedOffer.offerOption.connectDate" placeholder="01/29/14"
                   datepicker-popup is-open="datePickerOpened" ng-click="openDatePicker($event)" min-date="minDate" date-disabled="checkDisabledDate(date, mode)" datepicker-options="{ 'datepickerDateClass': 'checkDateClass(date)', 'datepickerDateClassScope': $id }" />
        </div>
        <div class="item item--no-input">
            <label for="connection-fee">@Html.Sitecore().Field("Connection Fee Label")</label>
            <strong>{{connectionFee | currency}}</strong>
        </div>
    </div>
    }
</script>